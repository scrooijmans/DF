Can't start Docker

Describe the bug
I Followed the guide, and I changed the JWT, ANON and SERVICE values both in .env and kong
When I try to run docker compose up, I see those errors :

supabase_auth_admin@postgres FATAL: password authentication failed for user "supabase_auth_admin"
authenticator@postgres DETAIL: User "authenticator" has no password assigned.
User "supabase_auth_admin" has no password assigned.

I also tried to change DB_USER: ${POSTGRES_USER} to DB_USER: supabase_admin in the docker-compose.yml, but I got the same results

A clear and concise description of what the bug is.

To Reproduce
Steps to reproduce the behavior, please provide code snippets or a repository:

1 Follow the giude
2 docker compose up

System information
OS: macOs
Browser (if applies) [chrome/mozilla]
Version of Docker: [Docker version 20.10.22, build 3a2c30b]

Update; Seems like the solution for me was to delete the database volume (/volumes/db/data) and restart the services. I did a couple of tries before I had all the right environment vars set up (e.g. having an autogenerated password with an @ in it was not a good idea...). But changing the .env file and restarting the docker compose was not enough to get it up and running. Once the Postgres database was initialized the database would not re-configure itself based on new env vars. But removing the persistent data volume triggered a re-initialization and finally brought all services up.

******************************************************************************************************************************************************************************************************************

When we configure self-hosting on the website

POSTGRES_PASSWORD=your-super-secret-and-long-postgres-password
JWT_SECRET=your-super-secret-jwt-token-with-at-least-32-characters-long

The default password, even if we change the POSTGRES_PASSWORD, we also need to change the jwt according to our password. Otherwise, even if we change the postgres_password, the database password will continue to be your-super-secret-and-long-postgres-password.

Generate a new JWT based on your new password and place it in .env

root@6915028540bd:/# psql -U supabase_admin -d postgres -W
Password: your-super-secret-and-long-postgres-password

postgres=# ALTER USER supabase_admin WITH PASSWORD 'newPassword';
ALTER ROLE
postgres=# ALTER USER postgres WITH PASSWORD 'newPassword';
ALTER ROLE
postgres=# ALTER USER supabase_auth_admin WITH PASSWORD 'newPassword';
ALTER ROLE

********
I found the solution. You need to manually update the postgreSQL password:

Go to docker folder
cd supabase/docker

Access the PostgreSQL Container:
docker exec -it supabase-db bash

Log into PostgreSQL:
psql -U supabase_admin

Update the Password:
ALTER USER postgres WITH PASSWORD 'here you put the password that you set in the env file for the postgres password'; 

Exit PostgreSQL and the Container:
\q
exit
Restart the Container:
docker restart supabase-db

Give it a few minutes after this

********


This worked for me:

Update the env file JWT + ANON + SERVICE ROLE + DASHBOARD CREDS
https://supabase.com/docs/guides/self-hosting/docker#securing-your-services

Download OPENSLL on PC
In powershell:
GENERATE (32 character) VAULT_ENC_KEY:
& "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" rand -hex 16
GENERATE SECRET_KEY_BASE:
[Convert]::ToBase64String((1..64 | ForEach-Object {Get-Random -Maximum 256}))

Save the env file SECRET_KEY_BASE + VAULT_ENC_KEY

DO NOT update POSTGRES_PASSWORD yet

Make sure pooler.exs and env are LF not CRLF

docker compose down -v --remove-orphans
docker system prune --volumes -af
Remove-Item -Recurse -Force .\volumes\db\data
docker compose pull
with generic working env postgress password:
docker compose up -d --build
containers up and URL working.

docker exec -it supabase-db psql -U supabase_admin

CREATE SCHEMA IF NOT EXISTS _analytics;

CREATE TABLE _analytics.source_backends (
  id SERIAL PRIMARY KEY,
  source_id INT NOT NULL,
  type TEXT NOT NULL,
  config JSONB NOT NULL,
  inserted_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
INSERT INTO _analytics.source_backends (source_id, type, config)
VALUES (
  2,
  'postgres',
  '{"url": "postgresql://supabase_admin:PasswordGoesHere@db:5432/_supabase"}' 
);
SELECT * FROM _analytics.source_backends;

#(delete from or drop table - only if you need to!)
#DELETE FROM _analytics.source_backends;
#DROP TABLE _analytics.source_backends;
postgres=# exit

docker exec -it supabase-db psql -U supabase_admin -d _supabase

alter user supabase_admin with password 'PasswordGoesHere';
alter userpostgres with password 'PasswordGoesHere';
alter user supabase_auth_admin with password 'PasswordGoesHere';
alter user anon with password 'PasswordGoesHere';
alter user authenticated with password 'PasswordGoesHere';
alter user authenticator with password 'PasswordGoesHere';
alter user dashboard_user with password 'PasswordGoesHere';
alter user pgbouncer with password 'PasswordGoesHere';
alter user service_role with password 'PasswordGoesHere';
alter user supabase_admin with password 'PasswordGoesHere';
alter user supabase_functions_admin with password 'PasswordGoesHere';
alter user supabase_read_only_user with password 'PasswordGoesHere';
alter user supabase_replication_admin with password 'PasswordGoesHere';
alter user supabase_storage_admin with password 'PasswordGoesHere';
UPDATE _analytics.source_backends
SET config = jsonb_set(config, '{url}', '"postgresql://supabase_admin:PasswordGoesHere@db:5432/postgres"', 'false')
WHERE type='postgres';
docker compose down

NOW UPDATE the env file with new POSTGRES_PASSWORD

SAVE env.
docker compose up -d --build

Yeah cool, whatevs, love you too xxx



***************

Getting the same error as @nezzard

{"code":"PGRST000","details":"connection to server at "supabase-db" (172.31.0.4), port 5432 failed: FATAL: password authentication failed for user "authenticator"\n","hint":null,"message":"Database connection error. Retrying the connection."}

With the following in .env:

POSTGRES_HOST=supabase-db
POSTGRES_DB=postgres
POSTGRES_PORT=5432
POSTGRES_PASSWORD=*********
JWT_SECRET=*********
ANON_KEY=*********
SERVICE_ROLE_KEY=*********
PGRST_DB_SCHEMAS=public,storage,graphql_public
KONG_HTTP_PORT=8000
KONG_HTTPS_PORT=8443
Docker compose:

  supabase-api-gateway:
    container_name: supabase-kong
    image: kong:2.8.1
    restart: unless-stopped
    ports:
      - ${KONG_HTTP_PORT}:8000/tcp
      - ${KONG_HTTPS_PORT}:8443/tcp
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      # https://github.com/supabase/cli/issues/14
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl
      KONG_NGINX_PROXY_PROXY_BUFFER_SIZE: 160k
      KONG_NGINX_PROXY_PROXY_BUFFERS: 64 160k
    volumes:
      - ./volumes/api:/var/lib/kong:ro

  supabase-rest:
    container_name: supabase-rest
    image: postgrest/postgrest:v9.0.1.20220717
    depends_on:
      supabase-db: # Disable this if you are using an external Postgres database
        condition: service_healthy
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgres://authenticator:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      PGRST_DB_SCHEMAS: ${PGRST_DB_SCHEMAS}
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUCS: "false"

  supabase-storage:
    container_name: supabase-storage
    image: supabase/storage-api:v0.26.1
    depends_on:
      supabase-db: # Disable this if you are using an external Postgres database
        condition: service_healthy
      supabase-rest:
        condition: service_started
      # imgproxy:
      #   condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/status" ]
      timeout: 5s
      interval: 5s
      retries: 3
    restart: unless-stopped
    environment:
      ANON_KEY: ${ANON_KEY}
      SERVICE_KEY: ${SERVICE_ROLE_KEY}
      POSTGREST_URL: http://rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      # TODO: https://github.com/supabase/storage-api/issues/55
      REGION: stub
      GLOBAL_S3_BUCKET: stub
      ENABLE_IMAGE_TRANSFORMATION: "false"
      # IMGPROXY_URL: http://imgproxy:5001
    volumes:
      - ./volumes/storage:/var/lib/storage

  # Comment out everything below this point if you are using an external Postgres database
  supabase-db:
    container_name: supabase-db
    image: supabase/postgres:14.1.0.106
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - log_min_messages=fatal # prevents Realtime polling queries from appearing in logs
    restart: unless-stopped
    ports:
      # Pass down internal port because it's set dynamically by other services
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    environment:
      POSTGRES_HOST: /var/run/postgresql
      PGPORT: ${POSTGRES_PORT}
      POSTGRES_PORT: ${POSTGRES_PORT}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./volumes/db/realtime.sql:/docker-entrypoint-initdb.d/realtime.sql
      - ./volumes/db/roles.sql:/docker-entrypoint-initdb.d/roles.sql
      # Must be superuser to enable pg_net extension
      - ./volumes/db/webhooks.sql:/etc/postgresql.schema.sql
      - ./volumes/db/data:/var/lib/postgresql/data
kjetilk-kontali
kjetilk-kontali commented on Feb 20, 2023
kjetilk-kontali
on Feb 20, 2023
Update; Seems like the solution for me was to delete the database volume (/volumes/db/data) and restart the services. I did a couple of tries before I had all the right environment vars set up (e.g. having an autogenerated password with an @ in it was not a good idea...). But changing the .env file and restarting the docker compose was not enough to get it up and running. Once the Postgres database was initialized the database would not re-configure itself based on new env vars. But removing the persistent data volume triggered a re-initialization and finally brought all services up.

campioncino
campioncino commented on Feb 21, 2023
campioncino
on Feb 21, 2023
Author
I solved the problem with a deep clean.

Removed and re-install all : github folder, docker etc.

After that I successfully started supabase with docker compose.

sweatybridge
sweatybridge commented on Mar 9, 2023
sweatybridge
on Mar 9, 2023
Contributor
Yup, cleaning the pgdata volume is necessary because most users want their data to persist between restarts. Closing as resolved.


sweatybridge
closed this as completedon Mar 9, 2023
prescience-data
prescience-data commented on May 9, 2023
prescience-data
on May 9, 2023
Old issue, but for anyone searching for this error, autogenerated passwords with special characters read from .env file was the cause in my case.

After resetting database password to alphanumeric with safe special characters (ie _) works as expected.

egdavid
egdavid commented on May 18, 2023
egdavid
on May 18, 2023
In my case I had to:

docker system prune -a
sudo rm -rf docker/volumes/db/data
docker compose up
After I edited both my .env files, in /docker and in /studio

********************************************************

 password authentication failed for user "supabase_auth_admin" - Docker Sefl Hosting #11957
campioncino posted onGitHub 

Bug report
Can't start Docker

Describe the bug
I Followed the guide, and I changed the JWT, ANON and SERVICE values both in .env and kong When I try to run docker compose up, I see those errors :

supabase_auth_admin@postgres FATAL: password authentication failed for user "supabase_auth_admin" authenticator@postgres DETAIL: User "authenticator" has no password assigned. User "supabase_auth_admin" has no password assigned.

I also tried to change DB_USER: ${POSTGRES_USER} to DB_USER: supabase_admin in the docker-compose.yml, but I got the same results

A clear and concise description of what the bug is.

To Reproduce
Steps to reproduce the behavior, please provide code snippets or a repository:

1 Follow the giude 2 docker compose up

System information
OS: macOs
Browser (if applies) [chrome/mozilla]
Version of Docker: [Docker version 20.10.22, build 3a2c30b]
Additional context
Add any other context about the problem here.


I am also facing the the same issue.

OS: Windows 11
Browser: Mozilla
Version of Docker: Docker (Desktop with WSL backend) version 20.10.22, build 3a2c30b The supabase supabase-auth container spits the following error:
2023-01-30 21:26:58 {"level":"info","msg":"Go runtime metrics collection started","time":"2023-01-31T00:26:58Z"}
2023-01-30 21:26:58 {"args":[0.014355398],"component":"pop","level":"info","msg":"%.4f seconds","time":"2023-01-31T00:26:58Z"}
2023-01-30 21:26:58 {"level":"fatal","msg":"running db migrations: Migrator: problem creating schema migrations: couldn't start a new transaction: could not create new transaction: failed to connect to `host=db user=supabase_auth_admin database=postgres`: failed SASL auth (FATAL: password authentication failed for user \"supabase_auth_admin\" (SQLSTATE 28P01))","time":"2023-01-31T00:26:58Z"}
if the default POSTGRES_PASSWORD in the .env file is changed to anything else other than your-super-secret-and-long-postgres-password
posted by MatiasLGonzalez over 2 years ago

docker version : Using the default parameters (without any changes) this is what I see : WARN[0000] The "MFA_ENABLED" variable is not set. Defaulting to a blank string. [+] Running 11/11 ⠿ studio Pulled 12.0s ⠿ 548fcab5fe88 Already exists 0.0s ⠿ cc40c8ff9db0 Already exists 0.0s ⠿ 3f8487d8d1dc Already exists 0.0s ⠿ 5619421d892a Already exists 0.0s ⠿ 15658185d04a Already exists 0.0s ⠿ 9ff9fd951310 Pull complete 0.6s ⠿ 6bbf1858a5f7 Pull complete 9.4s ⠿ 94f414cb81bb Pull complete 9.6s ⠿ 6b13fc5c8a10 Pull complete 9.8s ⠿ 4f4fb700ef54 Pull complete 9.9s [+] Running 10/10 ⠿ Network docker_default Created 0.1s ⠿ Container supabase-studio Started 4.0s ⠿ Container supabase-kong Started 4.0s ⠿ Container supabase-imgproxy Started 3.9s ⠿ Container supabase-db Healthy 10.8s ⠿ Container supabase-meta Started 8.9s ⠿ Container supabase-auth Started 7.4s ⠿ Container supabase-rest Started 9.0s ⠿ Container realtime-dev.supabase-realtime Started 7.0s ⠿ Container supabase-storage Started 9.2s

logs : supabase-db | supabase-db | PostgreSQL Database directory appears to contain a database; Skipping initialization supabase-db | supabase-db | 192.168.0.7 2023-02-02 09:13:42.850 UTC [53] supabase_auth_admin@postgres FATAL: password authentication failed for user "supabase_auth_admin" supabase-db | 192.168.0.7 2023-02-02 09:13:42.850 UTC [53] supabase_auth_admin@postgres DETAIL: User "supabase_auth_admin" has no password assigned.

What's wrong?

posted by campioncino over 2 years ago

Have same error, changed jwt anon and service keys, and getting an error password authentication failed for user "postgres" But if I read env file from container, password the same as in .env

posted by nezzard over 2 years ago

Getting the same error as @nezzard

{"code":"PGRST000","details":"connection to server at "supabase-db" (172.31.0.4), port 5432 failed: FATAL: password authentication failed for user "authenticator"\n","hint":null,"message":"Database connection error. Retrying the connection."}

With the following in .env:

POSTGRES_HOST=supabase-db
POSTGRES_DB=postgres
POSTGRES_PORT=5432
POSTGRES_PASSWORD=*********
JWT_SECRET=*********
ANON_KEY=*********
SERVICE_ROLE_KEY=*********
PGRST_DB_SCHEMAS=public,storage,graphql_public
KONG_HTTP_PORT=8000
KONG_HTTPS_PORT=8443
Docker compose:

  supabase-api-gateway:
    container_name: supabase-kong
    image: kong:2.8.1
    restart: unless-stopped
    ports:
      - ${KONG_HTTP_PORT}:8000/tcp
      - ${KONG_HTTPS_PORT}:8443/tcp
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      # https://github.com/supabase/cli/issues/14
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl
      KONG_NGINX_PROXY_PROXY_BUFFER_SIZE: 160k
      KONG_NGINX_PROXY_PROXY_BUFFERS: 64 160k
    volumes:
      - ./volumes/api:/var/lib/kong:ro

  supabase-rest:
    container_name: supabase-rest
    image: postgrest/postgrest:v9.0.1.20220717
    depends_on:
      supabase-db: # Disable this if you are using an external Postgres database
        condition: service_healthy
    restart: unless-stopped
    environment:
      PGRST_DB_URI: postgres://authenticator:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      PGRST_DB_SCHEMAS: ${PGRST_DB_SCHEMAS}
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_USE_LEGACY_GUCS: "false"

  supabase-storage:
    container_name: supabase-storage
    image: supabase/storage-api:v0.26.1
    depends_on:
      supabase-db: # Disable this if you are using an external Postgres database
        condition: service_healthy
      supabase-rest:
        condition: service_started
      # imgproxy:
      #   condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/status" ]
      timeout: 5s
      interval: 5s
      retries: 3
    restart: unless-stopped
    environment:
      ANON_KEY: ${ANON_KEY}
      SERVICE_KEY: ${SERVICE_ROLE_KEY}
      POSTGREST_URL: http://rest:3000
      PGRST_JWT_SECRET: ${JWT_SECRET}
      DATABASE_URL: postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      FILE_SIZE_LIMIT: 52428800
      STORAGE_BACKEND: file
      FILE_STORAGE_BACKEND_PATH: /var/lib/storage
      TENANT_ID: stub
      # TODO: https://github.com/supabase/storage-api/issues/55
      REGION: stub
      GLOBAL_S3_BUCKET: stub
      ENABLE_IMAGE_TRANSFORMATION: "false"
      # IMGPROXY_URL: http://imgproxy:5001
    volumes:
      - ./volumes/storage:/var/lib/storage

  # Comment out everything below this point if you are using an external Postgres database
  supabase-db:
    container_name: supabase-db
    image: supabase/postgres:14.1.0.106
    healthcheck:
      test: pg_isready -U postgres -h localhost
      interval: 5s
      timeout: 5s
      retries: 10
    command:
      - postgres
      - -c
      - config_file=/etc/postgresql/postgresql.conf
      - -c
      - log_min_messages=fatal # prevents Realtime polling queries from appearing in logs
    restart: unless-stopped
    ports:
      # Pass down internal port because it's set dynamically by other services
      - ${POSTGRES_PORT}:${POSTGRES_PORT}
    environment:
      POSTGRES_HOST: /var/run/postgresql
      PGPORT: ${POSTGRES_PORT}
      POSTGRES_PORT: ${POSTGRES_PORT}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATABASE: ${POSTGRES_DB}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./volumes/db/realtime.sql:/docker-entrypoint-initdb.d/realtime.sql
      - ./volumes/db/roles.sql:/docker-entrypoint-initdb.d/roles.sql
      # Must be superuser to enable pg_net extension
      - ./volumes/db/webhooks.sql:/etc/postgresql.schema.sql
      - ./volumes/db/data:/var/lib/postgresql/data
posted by kjetilk-kontali over 2 years ago

Update; Seems like the solution for me was to delete the database volume (/volumes/db/data) and restart the services. I did a couple of tries before I had all the right environment vars set up (e.g. having an autogenerated password with an @ in it was not a good idea...). But changing the .env file and restarting the docker compose was not enough to get it up and running. Once the Postgres database was initialized the database would not re-configure itself based on new env vars. But removing the persistent data volume triggered a re-initialization and finally brought all services up.

posted by kjetilk-kontali over 2 years ago

I solved the problem with a deep clean.

Removed and re-install all : github folder, docker etc.

After that I successfully started supabase with docker compose.

posted by campioncino over 2 years ago

Yup, cleaning the pgdata volume is necessary because most users want their data to persist between restarts. Closing as resolved.

posted by sweatybridge over 2 years ago

Old issue, but for anyone searching for this error, autogenerated passwords with special characters read from .env file was the cause in my case.

After resetting database password to alphanumeric with safe special characters (ie _) works as expected.

posted by prescience-data over 2 years ago

In my case I had to:

docker system prune -a
sudo rm -rf docker/volumes/db/data
docker compose up
After I edited both my .env files, in /docker and in /studio

posted by egdavid over 2 years ago

Cleaning the volumens/db/data allows to initialize the supabase postgres. But it stops before completing with error:

supabase-postgres  | /docker-entrypoint-initdb.d/migrate.sh: running /docker-entrypoint-initdb.d/init-scripts/99-roles.sql
supabase-postgres  | ALTER ROLE
supabase-postgres  | ALTER ROLE
supabase-postgres  | ALTER ROLE
supabase-postgres  | psql:/docker-entrypoint-initdb.d/init-scripts/99-roles.sql:7: ERROR:  role "supabase_functions_admin" does not exist
supabase-postgres exited with code 0
supabase-postgres  | 
supabase-postgres  | PostgreSQL Database directory appears to contain a database; Skipping initialization
supabase-postgres  | 
posted by kivi over 2 years ago

In my case I had to:

docker system prune -a
sudo rm -rf docker/volumes/db/data
docker compose up
After I edited both my .env files, in /docker and in /studio

Even though it's a closed topic, it seems to be a common and recurring problem.

I definitely can't debug what needs to be fixed between the two .env files, both in /docker and /studio. I'm evaluating variable by variable, but I can't easily bring up this stack. Could the developers or a good soul, help with a test deployment (docker-compose.yaml + .env files) that actually works out of the box?

I swear I keep reading and rereading the documentation and conducting new tests in my spare time. But a light at the end of the tunnel would be immensely valuable! Thank you.

posted by andersonid over 2 years ago

In my case I had to:

docker system prune -a
sudo rm -rf docker/volumes/db/data
docker compose up
After I edited both my .env files, in /docker and in /studio

This worked for me as well (and following the setup instructions for the ANON and SERVICE keys).

posted by GHMT about 2 years ago

just delete supabase/docker/volumes/storage

posted by scr2em about 2 years ago
