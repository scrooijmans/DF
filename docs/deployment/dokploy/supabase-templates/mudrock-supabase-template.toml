[template]
name = "MudRock Supabase"
description = "Standalone Supabase deployment for MudRock project with proper auth configuration"
version = "1.0.0"
category = "Database"
tags = ["supabase", "postgres", "auth", "realtime", "storage"]

[template.variables]
# Domain Configuration
SUPABASE_DOMAIN = { type = "string", default = "supabase.yourdomain.com", description = "Domain for Supabase services" }
SITE_URL = { type = "string", default = "https://yourdomain.com", description = "Your main application URL" }

# Database Configuration
POSTGRES_PASSWORD = { type = "string", default = "your-super-secret-and-long-postgres-password", description = "PostgreSQL password" }
POSTGRES_DB = { type = "string", default = "postgres", description = "PostgreSQL database name" }

# JWT Configuration
JWT_SECRET = { type = "string", default = "your-super-secret-jwt-token-with-at-least-32-characters-long", description = "JWT secret for authentication" }

# Dashboard Authentication
DASHBOARD_USERNAME = { type = "string", default = "admin", description = "Supabase Studio username" }
DASHBOARD_PASSWORD = { type = "string", default = "your-secure-dashboard-password", description = "Supabase Studio password" }

# SMTP Configuration (for email auth)
SMTP_HOST = { type = "string", default = "", description = "SMTP host for email authentication" }
SMTP_PORT = { type = "string", default = "587", description = "SMTP port" }
SMTP_USER = { type = "string", default = "", description = "SMTP username" }
SMTP_PASS = { type = "string", default = "", description = "SMTP password" }
SMTP_ADMIN_EMAIL = { type = "string", default = "admin@yourdomain.com", description = "Admin email address" }
SMTP_SENDER_NAME = { type = "string", default = "MudRock", description = "Email sender name" }

# OAuth Providers (disabled - using Supabase Auth only)
# GITHUB_CLIENT_ID = { type = "string", default = "", description = "GitHub OAuth Client ID" }
# GITHUB_CLIENT_SECRET = { type = "string", default = "", description = "GitHub OAuth Client Secret" }
# GOOGLE_CLIENT_ID = { type = "string", default = "", description = "Google OAuth Client ID" }
# GOOGLE_CLIENT_SECRET = { type = "string", default = "", description = "Google OAuth Client Secret" }

# Storage Configuration
STORAGE_BACKEND = { type = "string", default = "file", description = "Storage backend (file or s3)" }
GLOBAL_S3_BUCKET = { type = "string", default = "", description = "S3 bucket name (if using S3)" }
REGION = { type = "string", default = "us-east-1", description = "AWS region (if using S3)" }

[template.services.supabase]
image = "supabase/postgres:15.1.0.117"
restart = "unless-stopped"
environment = [
  "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}",
  "POSTGRES_DB=${POSTGRES_DB}",
  "POSTGRES_INITDB_ARGS=--auth-host=scram-sha-256",
  "POSTGRES_HOST_AUTH_METHOD=scram-sha-256"
]
volumes = [
  "supabase_db_data:/var/lib/postgresql/data"
]
ports = ["5432:5432"]
healthcheck = { test = ["CMD-SHELL", "pg_isready -U postgres"], interval = "10s", timeout = "5s", retries = 5 }

[template.services.supabase-auth]
image = "supabase/gotrue:v2.158.1"
restart = "unless-stopped"
depends_on = ["supabase"]
environment = [
  "GOTRUE_API_HOST=0.0.0.0",
  "GOTRUE_API_PORT=9999",
  "GOTRUE_DB_DRIVER=postgres",
  "GOTRUE_DB_DATABASE_URL=postgres://supabase_auth_admin:${POSTGRES_PASSWORD}@supabase:5432/${POSTGRES_DB}",
  "GOTRUE_SITE_URL=${SITE_URL}",
  "GOTRUE_URI_ALLOW_LIST=${SITE_URL}",
  "GOTRUE_JWT_SECRET=${JWT_SECRET}",
  "GOTRUE_JWT_EXP=3600",
  "GOTRUE_JWT_AUD=authenticated",
  "GOTRUE_JWT_DEFAULT_GROUP_NAME=authenticated",
  "GOTRUE_JWT_ADMIN_ROLES=supabase_admin,service_role",
  "GOTRUE_DISABLE_SIGNUP=false",
  "GOTRUE_EXTERNAL_EMAIL_ENABLED=true",
  "GOTRUE_EXTERNAL_PHONE_ENABLED=true",
  "GOTRUE_MAILER_AUTOCONFIRM=true",
  "GOTRUE_MAILER_SECURE_EMAIL_CHANGE_ENABLED=true",
  "GOTRUE_SMTP_HOST=${SMTP_HOST}",
  "GOTRUE_SMTP_PORT=${SMTP_PORT}",
  "GOTRUE_SMTP_USER=${SMTP_USER}",
  "GOTRUE_SMTP_PASS=${SMTP_PASS}",
  "GOTRUE_SMTP_ADMIN_EMAIL=${SMTP_ADMIN_EMAIL}",
  "GOTRUE_SMTP_SENDER_NAME=${SMTP_SENDER_NAME}",
  "GOTRUE_EXTERNAL_GITHUB_ENABLED=false",
  "GOTRUE_EXTERNAL_GOOGLE_ENABLED=false"
]
ports = ["9999:9999"]

[template.services.supabase-rest]
image = "postgrest/postgrest:v12.2.0"
restart = "unless-stopped"
depends_on = ["supabase"]
environment = [
  "PGRST_DB_URI=postgres://authenticator:${POSTGRES_PASSWORD}@supabase:5432/${POSTGRES_DB}",
  "PGRST_DB_SCHEMAS=public,storage,graphql_public",
  "PGRST_DB_ANON_ROLE=anon",
  "PGRST_JWT_SECRET=${JWT_SECRET}",
  "PGRST_DB_USE_LEGACY_GUCS=false"
]
ports = ["3000:3000"]

[template.services.supabase-realtime]
image = "supabase/realtime:v2.30.15"
restart = "unless-stopped"
depends_on = ["supabase"]
environment = [
  "PORT=4000",
  "DB_HOST=supabase",
  "DB_PORT=5432",
  "DB_USER=supabase_admin",
  "DB_PASSWORD=${POSTGRES_PASSWORD}",
  "DB_NAME=${POSTGRES_DB}",
  "DB_AFTER_CONNECT_QUERY=SET search_path TO _realtime",
  "DB_ENC_KEY=supabaserealtime",
  "API_JWT_SECRET=${JWT_SECRET}",
  "FLY_ALLOC_ID=fly123",
  "FLY_APP_NAME=realtime",
  "SECRET_KEY_BASE=UpNVntn3cDxHJpq99YMc1T1AQgQpc8kfYTuRgBiYa15BLrx8etQoXz3gZv1/u2oq",
  "ERL_AFLAGS=-proto_dist inet_tcp",
  "ENABLE_TAILSCALE=false",
  "DNS_NODES="
]
ports = ["4000:4000"]

[template.services.supabase-storage]
image = "supabase/storage-api:v1.10.5"
restart = "unless-stopped"
depends_on = ["supabase"]
environment = [
  "ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0",
  "SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU",
  "POSTGREST_URL=http://supabase-rest:3000",
  "PGRST_JWT_SECRET=${JWT_SECRET}",
  "DATABASE_URL=postgres://supabase_storage_admin:${POSTGRES_PASSWORD}@supabase:5432/${POSTGRES_DB}",
  "FILE_SIZE_LIMIT=52428800",
  "STORAGE_BACKEND=${STORAGE_BACKEND}",
  "GLOBAL_S3_BUCKET=${GLOBAL_S3_BUCKET}",
  "REGION=${REGION}",
  "FILE_STORAGE_BACKEND_PATH=/var/lib/storage"
]
volumes = [
  "supabase_storage_data:/var/lib/storage"
]
ports = ["5000:5000"]

[template.services.supabase-kong]
image = "kong:2.8.1"
restart = "unless-stopped"
depends_on = ["supabase-auth", "supabase-rest", "supabase-realtime", "supabase-storage"]
environment = [
  "KONG_DATABASE=off",
  "KONG_DECLARATIVE_CONFIG=/var/lib/kong/kong.yml",
  "KONG_DNS_ORDER=LAST,A,CNAME",
  "KONG_PLUGINS=request-transformer,cors,key-auth,acl,basic-auth"
]
volumes = [
  "supabase_kong_data:/var/lib/kong"
]
ports = ["8000:8000"]

[template.services.supabase-studio]
image = "supabase/studio:20241215-0b8c8b4"
restart = "unless-stopped"
depends_on = ["supabase-kong"]
environment = [
  "STUDIO_PG_META_URL=http://supabase-meta:8080",
  "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}",
  "DEFAULT_ORGANIZATION_NAME=MudRock",
  "DEFAULT_PROJECT_NAME=Default Project",
  "SUPABASE_URL=https://${SUPABASE_DOMAIN}",
  "SUPABASE_PUBLIC_URL=https://${SUPABASE_DOMAIN}",
  "SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0",
  "SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU"
]
ports = ["3001:3000"]

[template.services.supabase-meta]
image = "supabase/postgres-meta:v0.84.2"
restart = "unless-stopped"
depends_on = ["supabase"]
environment = [
  "PG_META_PORT=8080",
  "PG_META_DB_HOST=supabase",
  "PG_META_DB_PORT=5432",
  "PG_META_DB_NAME=${POSTGRES_DB}",
  "PG_META_DB_USER=supabase_admin",
  "PG_META_DB_PASSWORD=${POSTGRES_PASSWORD}"
]
ports = ["8080:8080"]

[template.volumes]
supabase_db_data = {}
supabase_storage_data = {}
supabase_kong_data = {}

[template.networks]
supabase_network = { driver = "bridge" }
