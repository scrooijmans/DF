# DataForge Sync Server - Production Docker Compose
#
# Production deployment configuration with:
# - DataForge Sync Server (authenticated)
# - External S3/MinIO storage (configure via environment)
#
# Usage:
#   cp .env.example .env
#   # Edit .env with production values
#   docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ===========================================================================
  # DataForge Sync Server - Production
  # ===========================================================================
  sync:
    build:
      context: ..
      dockerfile: docker/Dockerfile.sync-server
    container_name: dataforge-sync
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Server configuration
      RUST_LOG: "info"
      SYNC_SERVER_PORT: "3000"
      SYNC_SERVER_DB_PATH: "/data/sync.db"

      # Authentication (REQUIRED for production)
      SYNC_AUTH_SKIP: "false"
      SYNC_AUTH_SECRET: "${SYNC_AUTH_SECRET:?SYNC_AUTH_SECRET is required}"
      SYNC_AUTH_EXPIRY: "${SYNC_AUTH_EXPIRY:-3600}"

      # Storage configuration (S3/MinIO)
      STORAGE_BACKEND: "${STORAGE_BACKEND:-s3}"
      STORAGE_ENDPOINT: "${STORAGE_ENDPOINT:-}"
      STORAGE_BUCKET: "${STORAGE_BUCKET:?STORAGE_BUCKET is required}"
      STORAGE_REGION: "${STORAGE_REGION:-us-east-1}"
      STORAGE_ACCESS_KEY: "${STORAGE_ACCESS_KEY:?STORAGE_ACCESS_KEY is required}"
      STORAGE_SECRET_KEY: "${STORAGE_SECRET_KEY:?STORAGE_SECRET_KEY is required}"
    volumes:
      - sync-data:/data
    networks:
      - dataforge-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

networks:
  dataforge-net:
    driver: bridge

volumes:
  sync-data:
    driver: local
